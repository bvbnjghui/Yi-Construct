<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daoist Battler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import gameEngine from './src/engine.js';
        document.addEventListener('alpine:init', () => {
            Alpine.data('game', gameEngine);
        });
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen flex items-center justify-center font-sans overflow-hidden">

    <div x-data="game"
        class="w-full max-w-md h-screen md:h-auto md:aspect-[9/16] md:max-h-[850px] bg-slate-900 md:rounded-2xl shadow-2xl border-x md:border border-slate-800 flex flex-col relative overflow-hidden">

        <!-- Language Toggle (Menu Only) -->
        <button @click="toggleLang()" x-show="gameState === 'menu'"
            class="absolute top-4 right-4 z-[60] px-2 py-1 text-[10px] font-bold text-slate-500 border border-slate-700 rounded hover:bg-slate-800 hover:text-slate-300 transition-colors"
            x-text="ui.langBtn">
        </button>

        <!-- === MENU / GAME OVER / VICTORY === -->
        <div x-show="gameState === 'menu' || gameState === 'gameover' || gameState === 'victory'"
            class="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur flex flex-col items-center justify-center space-y-8"
            x-transition>
            <div class="text-center">
                <h1 class="text-4xl font-bold text-amber-500 mb-2"
                    x-text="gameState === 'victory' ? ui.victory : (gameState === 'gameover' ? ui.gameOver : 'Daoist Battler')">
                </h1>
                <p class="text-slate-400" x-show="gameState === 'menu'">Roguelike Deckbuilder</p>
            </div>
            <div class="text-6xl animate-bounce">
                <span x-show="gameState === 'victory'">üèÜ</span>
                <span x-show="gameState === 'gameover'">üíÄ</span>
                <span x-show="gameState === 'menu'">‚òØÔ∏è</span>
            </div>
            <div class="flex flex-col gap-4">
                <button @click="startGame()"
                    class="px-8 py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-full shadow-lg shadow-amber-500/30 transition-all transform hover:scale-105 active:scale-95"
                    x-text="gameState === 'menu' ? ui.start : ui.retry">
                </button>
                <button @click="toggleHelp()" x-show="gameState === 'menu'"
                    class="px-8 py-2 border border-slate-600 hover:bg-slate-800 text-slate-300 font-bold rounded-full transition-all"
                    x-text="ui.howToPlay">
                </button>
            </div>
        </div>

        <!-- === HELP MODAL === -->
        <div x-show="showHelp"
            class="absolute inset-0 z-[60] bg-black/80 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-2xl relative">
                <button @click="toggleHelp()" class="absolute top-2 right-2 text-slate-500 hover:text-white">‚úï</button>
                <h2 class="text-xl font-bold text-amber-500 mb-4" x-text="ui.helpTitle"></h2>
                <ul class="space-y-2 text-sm text-slate-300 list-disc pl-4">
                    <template x-for="item in ui.helpContent">
                        <li x-text="item"></li>
                    </template>
                </ul>
                <div class="mt-6 text-center">
                    <button @click="toggleHelp()"
                        class="px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-white font-bold"
                        x-text="ui.close"></button>
                </div>
            </div>
        </div>

        <!-- === BACK TO MENU BUTTON (Top Right) === -->
        <button @click="backToMenu()" x-show="gameState === 'player_turn' || gameState === 'enemy_turn'"
            class="absolute top-4 right-4 z-40 px-2 py-1 text-[10px] font-bold text-slate-500 border border-slate-700 rounded hover:bg-slate-800 hover:text-slate-300 transition-colors"
            x-text="ui.backToMenu">
        </button>

        <!-- === ENEMY AREA (TOP) === -->
        <div
            class="flex-1 bg-slate-800/50 flex flex-col items-center justify-center relative border-b border-slate-700 p-4">
            <!-- Intent Bubble -->
            <div class="absolute top-4 left-4 bg-slate-900 px-3 py-1 rounded-full border border-slate-600 flex items-center gap-2 shadow-lg"
                x-show="enemy.hp > 0">
                <span x-show="enemy.intent.includes('attack')">‚öîÔ∏è</span>
                <span x-show="enemy.intent === 'defend'">üõ°Ô∏è</span>
                <span class="font-bold text-red-400" x-text="enemy.intentVal > 0 ? enemy.intentVal : ''"></span>
            </div>

            <!-- Enemy Avatar -->
            <div class="text-8xl mb-4 filter drop-shadow-lg transform transition-transform duration-500"
                :class="{'scale-110': gameState === 'enemy_turn'}">
                <span x-text="enemy.icon"></span>
            </div>

            <!-- Enemy HP Bar -->
            <div class="w-2/3 space-y-1">
                <div class="flex justify-between text-xs text-slate-400 font-bold">
                    <span x-text="enemy.name[lang]"></span>
                    <span><span x-text="enemy.hp"></span> / <span x-text="enemy.maxHp"></span></span>
                </div>
                <div class="h-3 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                    <div class="h-full bg-red-600 transition-all duration-300"
                        :style="`width: ${(enemy.hp / enemy.maxHp) * 100}%`"></div>
                </div>
            </div>
        </div>

        <!-- === PLAYER AREA (MIDDLE) === -->
        <div class="flex-none h-32 bg-slate-900 flex items-center justify-between px-8 border-b border-slate-800">
            <!-- Player Stats -->
            <div class="flex flex-col items-center gap-1">
                <div class="text-4xl">üßô‚Äç‚ôÇÔ∏è</div>
                <div class="text-xs font-bold text-slate-400">You</div>
            </div>

            <!-- HP & Block & Energy -->
            <div class="flex-1 ml-6 space-y-2">
                <!-- Block & Energy Row -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-cyan-400 font-bold" x-show="player.block > 0">
                        <span class="text-xl">üõ°Ô∏è</span>
                        <span x-text="player.block"></span>
                    </div>
                    <!-- Energy Display -->
                    <div class="flex items-center gap-1 text-yellow-400 font-bold ml-auto">
                        <span class="text-xl">‚ö°</span>
                        <span x-text="`${player.energy}/${player.maxEnergy}`"></span>
                    </div>
                </div>

                <!-- HP Bar -->
                <div class="w-full space-y-1">
                    <div class="flex justify-between text-xs text-slate-400 font-bold">
                        <span x-text="ui.hp"></span>
                        <span><span x-text="player.hp"></span> / <span x-text="player.maxHp"></span></span>
                    </div>
                    <div class="h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-700 relative">
                        <div class="h-full bg-green-600 transition-all duration-300"
                            :style="`width: ${(player.hp / player.maxHp) * 100}%`"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === COMBAT LOG (OVERLAY) === -->
        <div
            class="absolute top-1/2 left-0 right-0 pointer-events-none flex flex-col items-center justify-center space-y-1 z-10 opacity-80">
            <template x-for="(log, index) in combatLog" :key="index">
                <div class="text-sm font-bold text-white bg-black/50 px-2 py-0.5 rounded backdrop-blur-sm" x-text="log"
                    x-show="index < 3" x-transition></div>
            </template>
        </div>

        <!-- === CONTROLS (BOTTOM) === -->
        <div class="flex-1 bg-slate-900 p-4 flex flex-col gap-2">

            <!-- Hexagram Construction (Compact) -->
            <div
                class="h-24 bg-slate-950 rounded-lg border border-slate-800 p-2 flex flex-col-reverse justify-start gap-1 relative overflow-hidden shrink-0">
                <!-- Preview Stats -->
                <template x-if="previewStats">
                    <div class="absolute top-2 right-2 text-xs text-slate-500 font-mono text-right">
                        <div x-show="previewStats.atk > 0" class="text-red-400">ATK: <span
                                x-text="previewStats.atk"></span></div>
                        <div x-show="previewStats.def > 0" class="text-cyan-400">DEF: <span
                                x-text="previewStats.def"></span></div>
                        <div x-show="previewStats.heal > 0" class="text-green-400">HEAL: <span
                                x-text="previewStats.heal"></span></div>
                        <div x-show="previewStats.isResonance" class="text-amber-400 font-bold animate-pulse">RESONANCE!
                        </div>
                    </div>
                </template>

                <template x-for="(line, index) in lines" :key="index">
                    <div class="w-full transition-all duration-100">
                        <template x-if="line === 1">
                            <div class="h-2 w-full bg-amber-500 rounded shadow-sm"></div>
                        </template>
                        <template x-if="line === 0">
                            <div class="flex gap-2 h-2 w-full">
                                <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                                <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                            </div>
                        </template>
                    </div>
                </template>

                <div x-show="lines.length === 0" class="text-center text-slate-700 text-xs italic mt-auto mb-auto">
                    Construct Spell...
                </div>
            </div>

            <!-- Hand Area -->
            <div class="flex-1 flex items-center justify-center gap-2 relative">
                <!-- Deck Pile -->
                <div class="absolute left-0 bottom-2 text-xs text-slate-500 flex flex-col items-center">
                    <div class="w-8 h-10 bg-slate-800 border border-slate-700 rounded mb-1"></div>
                    <span x-text="`${ui.deck}: ${deck.length}`"></span>
                </div>

                <!-- Cards -->
                <div class="flex gap-2 items-end h-full pb-2 px-10 overflow-x-auto w-full justify-center">
                    <template x-for="(card, index) in hand" :key="card.id">
                        <button @click="playCard(index)"
                            class="w-16 h-24 rounded-lg shadow-lg border-2 flex flex-col items-center justify-between p-2 transition-transform hover:-translate-y-2 active:scale-95 relative group"
                            :class="card.type === 1 ? 'bg-slate-800 border-amber-600 text-amber-100' : 'bg-slate-800 border-cyan-600 text-cyan-100'">

                            <!-- Cost -->
                            <div
                                class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center text-xs font-bold text-yellow-400 shadow">
                                <span x-text="card.cost"></span>
                            </div>

                            <div class="text-2xl mt-2 whitespace-nowrap" x-text="card.type === 1 ? '‚Äî' : '--'"></div>
                            <div class="text-xs font-bold" x-text="card.name[lang]"></div>
                        </button>
                    </template>
                </div>

                <!-- Discard Pile -->
                <div class="absolute right-0 bottom-2 text-xs text-slate-500 flex flex-col items-center">
                    <div class="w-8 h-10 bg-slate-800 border border-slate-700 rounded mb-1"></div>
                    <span x-text="`${ui.discard}: ${discard.length}`"></span>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="h-12 flex gap-2">
                <!-- CAST BUTTON -->
                <button @click="castHexagram()" :disabled="lines.length !== 6"
                    class="flex-1 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-800 disabled:text-slate-600 text-white font-bold rounded shadow-lg transition-all flex items-center justify-center">
                    <span x-text="ui.cast"></span>
                </button>

                <!-- END TURN -->
                <button @click="endTurn()"
                    class="w-1/3 bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold rounded shadow-lg transition-all flex items-center justify-center border border-slate-600">
                    <span x-text="ui.endTurn"></span>
                </button>
            </div>
        </div>

    </div>

</body>

</html>