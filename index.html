<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v5: Added Undo Button -->
    <title>Daoist Battler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import gameEngine from './src/engine.js';
        document.addEventListener('alpine:init', () => {
            Alpine.data('game', gameEngine);
        });
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen flex items-center justify-center font-sans overflow-hidden">

    <div x-data="game"
        class="w-full max-w-md h-screen md:h-auto md:aspect-[9/16] md:max-h-[850px] bg-slate-900 md:rounded-2xl shadow-2xl border-x md:border border-slate-800 flex flex-col relative overflow-hidden">

        <!-- Language Toggle (Menu Only) -->
        <button @click="toggleLang()" x-show="gameState === 'menu'"
            class="absolute top-4 right-4 z-[60] px-2 py-1 text-[10px] font-bold text-slate-500 border border-slate-700 rounded hover:bg-slate-800 hover:text-slate-300 transition-colors"
            x-text="ui.langBtn">
        </button>

        <!-- === MENU / GAME OVER / VICTORY === -->
        <div x-show="gameState === 'menu' || gameState === 'gameover' || gameState === 'victory'"
            class="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur flex flex-col items-center justify-center space-y-8"
            x-transition>
            <div class="text-center">
                <h1 class="text-4xl font-bold text-amber-500 mb-2"
                    x-text="gameState === 'victory' ? ui.victory : (gameState === 'gameover' ? ui.gameOver : 'Daoist Battler')">
                </h1>
                <p class="text-slate-400" x-show="gameState === 'menu'">Roguelike Deckbuilder</p>
            </div>
            <div class="text-6xl animate-bounce">
                <span x-show="gameState === 'victory'">üèÜ</span>
                <span x-show="gameState === 'gameover'">üíÄ</span>
                <span x-show="gameState === 'menu'">‚òØÔ∏è</span>
            </div>
            <div class="flex flex-col gap-4">
                <button @click="startGame()"
                    class="px-8 py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-full shadow-lg shadow-amber-500/30 transition-all transform hover:scale-105 active:scale-95"
                    x-text="gameState === 'menu' ? ui.start : ui.retry">
                </button>
                <button @click="showCompendium = true" x-show="gameState === 'menu'"
                    class="px-8 py-2 bg-slate-800 hover:bg-slate-700 border border-amber-600/50 text-amber-400 font-bold rounded-full transition-all transform hover:scale-105"
                    x-text="lang === 'zh' ? 'ÂÖ≠ÂçÅÂõõÂç¶ÂúñÈëë' : 'Hexagram Compendium'">
                </button>
                <button @click="toggleHelp()" x-show="gameState === 'menu'"
                    class="px-8 py-2 border border-slate-600 hover:bg-slate-800 text-slate-300 font-bold rounded-full transition-all"
                    x-text="ui.howToPlay">
                </button>
            </div>
        </div>

        <!-- === HELP MODAL === -->
        <div x-show="showHelp"
            class="absolute inset-0 z-[60] bg-black/80 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-2xl relative">
                <button @click="toggleHelp()" class="absolute top-2 right-2 text-slate-500 hover:text-white">‚úï</button>
                <h2 class="text-xl font-bold text-amber-500 mb-4" x-text="ui.helpTitle"></h2>
                <ul class="space-y-2 text-sm text-slate-300 list-disc pl-4">
                    <template x-for="item in ui.helpContent">
                        <li x-text="item"></li>
                    </template>
                </ul>
                <div class="mt-6 text-center">
                    <button @click="toggleHelp()"
                        class="px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-white font-bold"
                        x-text="ui.close"></button>
                </div>
            </div>
        </div>

        <!-- === HEXAGRAM COMPENDIUM === -->
        <div x-show="showCompendium"
            class="absolute inset-0 z-[60] bg-black/90 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div
                class="bg-slate-900 border border-amber-600 rounded-xl max-w-4xl w-full max-h-[90%] shadow-2xl relative flex flex-col">
                <!-- Fixed Header -->
                <div class="flex-shrink-0 p-6 pb-4 border-b border-slate-800">
                    <button @click="showCompendium = false"
                        class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl z-10">‚úï</button>

                    <h2 class="text-2xl font-bold text-amber-500 mb-2 text-center"
                        x-text="lang === 'zh' ? 'ÂÖ≠ÂçÅÂõõÂç¶ÂúñÈëë' : 'Hexagram Compendium'"></h2>
                    <p class="text-center text-slate-400 text-sm"
                        x-text="lang === 'zh' ? 'ÊòìÁ∂ìÂÖ≠ÂçÅÂõõÂç¶ÂÆåÊï¥ÂàóË°®' : 'Complete list of 64 hexagrams from I Ching'"></p>
                </div>

                <!-- Scrollable Start -->
                <div class="flex-1 overflow-y-auto p-6 py-4">
                    <!-- Hexagram Grid -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <template x-for="hexId in Object.keys(HEX_DATA).map(Number).sort((a,b) => a-b)" :key="hexId">
                            <div class="bg-slate-950 border border-slate-700 hover:border-amber-600 rounded-lg p-3 transition-all cursor-pointer group"
                                @click="selectedHexagram = hexId">
                                <!-- Hexagram Visual -->
                                <div class="flex flex-col-reverse gap-0.5 mb-2">
                                    <template x-for="i in 6" :key="i">
                                        <div class="w-full h-1.5">
                                            <!-- Yang line -->
                                            <div x-show="(hexId >> (i-1)) & 1"
                                                class="h-full w-full bg-amber-500 rounded-sm"></div>
                                            <!-- Yin line -->
                                            <div x-show="!((hexId >> (i-1)) & 1)" class="flex gap-1 h-full">
                                                <div class="h-full w-1/2 bg-cyan-600 rounded-sm"></div>
                                                <div class="h-full w-1/2 bg-cyan-600 rounded-sm"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Hexagram Info -->
                                <div class="text-center">
                                    <div class="text-xs text-slate-500 mb-1">#<span x-text="hexId"></span></div>
                                    <div class="font-bold text-amber-400 text-sm group-hover:text-amber-300"
                                        x-text="HEX_DATA[hexId].name[lang]"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Fixed Footer -->
                <div class="flex-shrink-0 p-6 pt-4 border-t border-slate-800 text-center">
                    <button @click="showCompendium = false"
                        class="px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-white font-bold"
                        x-text="lang === 'zh' ? 'ÈóúÈñâ' : 'Close'"></button>
                </div>
            </div>
        </div>

        <!-- === HEXAGRAM DETAIL MODAL === -->
        <div x-show="selectedHexagram !== null"
            class="absolute inset-0 z-[70] bg-black/90 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div
                class="bg-slate-900 border border-amber-600 rounded-xl max-w-md w-full max-h-[90%] shadow-2xl relative flex flex-col">
                <!-- Fixed Header -->
                <div class="flex-shrink-0 p-6 pb-4 border-b border-slate-800">
                    <button @click="selectedHexagram = null"
                        class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl z-10">‚úï</button>

                    <template x-if="selectedHexagram !== null">
                        <div>
                            <div class="text-sm text-slate-500 mb-2 text-center">
                                <span x-text="lang === 'zh' ? 'Âç¶Ë±°Á∑®Ëôü' : 'Hexagram'"></span> #<span
                                    x-text="selectedHexagram"></span>
                            </div>
                            <h3 class="text-2xl font-bold text-amber-400 text-center"
                                x-text="HEX_DATA[selectedHexagram].name[lang]"></h3>
                        </div>
                    </template>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 py-4">
                    <template x-if="selectedHexagram !== null">
                        <div>
                            <!-- Hexagram Visual (Large) -->
                            <div
                                class="flex flex-col-reverse gap-1.5 mb-4 bg-slate-950 rounded-lg p-4 border border-slate-800">
                                <template x-for="i in 6" :key="i">
                                    <div class="w-full h-4 flex items-center gap-2">
                                        <div class="text-[10px] text-slate-500 font-bold w-6 text-right"
                                            x-text="['Âàù', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', '‰∏ä'][i-1]"></div>
                                        <div class="flex-1 h-full">
                                            <!-- Yang line (solid) -->
                                            <template x-if="getHexagramLine(selectedHexagram, i-1) === 1">
                                                <div class="h-full w-full bg-amber-500 rounded shadow-sm"></div>
                                            </template>
                                            <!-- Yin line (broken) -->
                                            <template x-if="getHexagramLine(selectedHexagram, i-1) === 0">
                                                <div class="flex gap-2 h-full">
                                                    <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                                                    <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Âç¶Ëæ≠ (Original Text) -->
                            <div class="mb-3 bg-slate-950 rounded-lg p-3 border border-slate-800">
                                <div class="text-xs text-amber-500 font-bold mb-1"
                                    x-text="lang === 'zh' ? 'Âç¶Ëæ≠' : 'Oracle'"></div>
                                <p class="text-slate-300 text-sm leading-relaxed italic"
                                    x-text="HEX_DATA[selectedHexagram].oracle[lang]"></p>
                            </div>

                            <!-- ÁôΩË©±Ëß£Èáã (Interpretation) -->
                            <div class="bg-slate-950 rounded-lg p-3 border border-slate-800">
                                <div class="text-xs text-cyan-500 font-bold mb-1"
                                    x-text="lang === 'zh' ? 'ÁôΩË©±Ëß£Èáã' : 'Interpretation'"></div>
                                <p class="text-slate-300 text-sm leading-relaxed"
                                    x-text="HEX_DATA[selectedHexagram].interpretation[lang]"></p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Fixed Footer -->
                <div class="flex-shrink-0 p-6 pt-4 border-t border-slate-800 text-center">
                    <button @click="selectedHexagram = null"
                        class="px-6 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white font-bold"
                        x-text="lang === 'zh' ? 'ËøîÂõû' : 'Back'"></button>
                </div>
            </div>
        </div>

        <!-- === SELECTION MODAL === -->
        <div x-show="gameState === 'selection'"
            class="absolute inset-0 z-[60] bg-black/90 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div class="bg-slate-900 border border-amber-600 rounded-xl p-6 max-w-sm w-full shadow-2xl relative">
                <h2 class="text-xl font-bold text-amber-500 mb-2 text-center"
                    x-text="lang === 'zh' ? 'Ë≠òÂà•Âç¶Ë±°' : 'Identify Hexagram'"></h2>

                <!-- Hexagram Visual -->
                <div class="bg-slate-950 rounded-lg border border-slate-800 p-3 mb-4 flex flex-col-reverse gap-1.5">
                    <template x-for="(line, index) in lines" :key="index">
                        <div class="w-full relative flex items-center gap-2">
                            <!-- Position Label (Âè≥ÂÅ¥) -->
                            <div class="text-[10px] text-slate-500 font-bold w-6 text-right shrink-0"
                                x-text="['Âàù', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', '‰∏ä'][index]">
                            </div>

                            <!-- Line Container -->
                            <div class="flex-1 relative">
                                <!-- Changing Line Indicator -->
                                <div x-show="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index)"
                                    class="absolute -inset-1 bg-yellow-400/40 rounded animate-pulse pointer-events-none shadow-lg shadow-yellow-500/50">
                                </div>

                                <template x-if="line === 1">
                                    <div class="h-3 w-full rounded shadow-sm relative flex items-center justify-center"
                                        :class="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index) 
                                            ? 'bg-yellow-400 ring-2 ring-yellow-300 shadow-lg shadow-yellow-500/50' 
                                            : 'bg-amber-500'">
                                        <!-- Changing Line Icon -->
                                        <span
                                            x-show="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index)"
                                            class="text-[10px] text-slate-900 font-bold">‚ö°</span>
                                    </div>
                                </template>
                                <template x-if="line === 0">
                                    <div class="flex gap-2 h-3 w-full relative">
                                        <div class="h-full w-1/2 rounded shadow-sm flex items-center justify-center"
                                            :class="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index) 
                                                ? 'bg-yellow-400 ring-2 ring-yellow-300 shadow-lg shadow-yellow-500/50' 
                                                : 'bg-cyan-600'">
                                            <span
                                                x-show="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index)"
                                                class="text-[8px] text-slate-900 font-bold">‚ö°</span>
                                        </div>
                                        <div class="h-full w-1/2 rounded shadow-sm flex items-center justify-center"
                                            :class="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index) 
                                                ? 'bg-yellow-400 ring-2 ring-yellow-300 shadow-lg shadow-yellow-500/50' 
                                                : 'bg-cyan-600'">
                                            <span
                                                x-show="transformationData && transformationData.changingPositions && transformationData.changingPositions.includes(index)"
                                                class="text-[8px] text-slate-900 font-bold">‚ö°</span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Changing Lines Info -->
                <div x-show="transformationData && transformationData.changingPositions && transformationData.changingPositions.length > 0"
                    class="mb-3 text-center text-xs text-yellow-300 flex items-center justify-center gap-2 bg-yellow-900/30 py-2 px-3 rounded-lg border border-yellow-600/30">
                    <span
                        class="inline-block w-2 h-2 bg-yellow-400 rounded-full animate-pulse shadow-lg shadow-yellow-500/50"></span>
                    <span x-text="lang === 'zh' 
                        ? `${transformationData.changingPositions.length} ÁàªÂãïÔºàÈáëÈªÉËâ≤ ‚ö° Ê®ôÁ§∫Ôºâ` 
                        : `${transformationData.changingPositions.length} changing line(s) (golden ‚ö° highlight)`">
                    </span>
                </div>

                <!-- Options -->
                <div class="space-y-2">
                    <template x-for="(option, index) in selectionOptions" :key="option.id">
                        <button @click="confirmSelection(index)"
                            class="w-full px-4 py-3 bg-slate-800 hover:bg-amber-600 border border-slate-600 hover:border-amber-500 rounded-lg text-left transition-all group">
                            <div class="font-bold text-amber-400 group-hover:text-white" x-text="option.name[lang]">
                            </div>
                            <div class="text-xs text-slate-400 group-hover:text-slate-200 mt-1"
                                x-text="option.description[lang]"></div>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- === REWARD MODAL === -->
        <div x-show="gameState === 'reward'"
            class="absolute inset-0 z-[60] bg-black/90 backdrop-blur flex items-center justify-center p-4" x-transition
            x-cloak>
            <div class="bg-slate-900 border border-amber-600 rounded-xl p-6 max-w-md w-full shadow-2xl relative">
                <h2 class="text-2xl font-bold text-amber-500 mb-4 text-center"
                    x-text="lang === 'zh' ? 'Êà∞È¨•ÂãùÂà©ÔºÅÈÅ∏ÊìáÁçéÂãµ' : 'Victory! Choose Reward'"></h2>
                <p class="text-center text-slate-400 text-sm mb-4" x-show="currentEnemyIndex + 1 < maxEnemies"
                    x-text="lang === 'zh' ? `Ê∫ñÂÇôÈù¢Â∞ç‰∏ã‰∏ÄÂÄãÊïµ‰∫∫ (${currentEnemyIndex + 2}/${maxEnemies})` : `Prepare for next enemy (${currentEnemyIndex + 2}/${maxEnemies})`">
                </p>

                <!-- Reward Cards -->
                <div class="space-y-3 mb-4">
                    <template x-for="(card, index) in rewardCards" :key="index">
                        <button @click="addCardToDeck(index)"
                            class="w-full px-4 py-3 bg-slate-800 hover:bg-amber-600 border border-slate-600 hover:border-amber-500 rounded-lg text-left transition-all group flex items-center gap-3">
                            <!-- Icon -->
                            <div class="text-4xl" x-text="card.icon"></div>
                            <!-- Info -->
                            <div class="flex-1">
                                <div class="font-bold text-amber-400 group-hover:text-white flex items-center gap-2">
                                    <span x-text="card.name[lang]"></span>
                                    <span class="text-xs bg-amber-500/20 px-2 py-0.5 rounded">‚ö°√ó<span
                                            x-text="card.changingLines ? card.changingLines.length : 0"></span></span>
                                </div>
                                <div class="text-xs text-slate-400 group-hover:text-slate-200 mt-1 flex gap-2">
                                    <span x-show="card.stats.atk > 0">ATK: <span x-text="card.stats.atk"></span></span>
                                    <span x-show="card.stats.def > 0">DEF: <span x-text="card.stats.def"></span></span>
                                    <span x-show="card.stats.heal > 0">HEAL: <span
                                            x-text="card.stats.heal"></span></span>
                                </div>
                            </div>
                        </button>
                    </template>
                </div>

                <!-- Skip Button -->
                <button @click="skipReward()"
                    class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-lg text-slate-300 hover:text-white transition-all"
                    x-text="lang === 'zh' ? 'Ë∑≥ÈÅé' : 'Skip'">
                </button>
            </div>
        </div>

        <!-- === BACK TO MENU BUTTON (Top Right) === -->
        <button @click="backToMenu()" x-show="gameState === 'player_turn' || gameState === 'enemy_turn'"
            class="absolute top-4 right-4 z-40 px-2 py-1 text-[10px] font-bold text-slate-500 border border-slate-700 rounded hover:bg-slate-800 hover:text-slate-300 transition-colors"
            x-text="ui.backToMenu">
        </button>

        <!-- === ENEMY AREA (TOP) === -->
        <div
            class="flex-1 bg-slate-800/50 flex flex-col items-center justify-center relative border-b border-slate-700 p-4">
            <!-- Intent Bubble -->
            <div class="absolute top-4 left-4 bg-slate-900 px-3 py-1 rounded-full border border-slate-600 flex items-center gap-2 shadow-lg"
                x-show="enemy.hp > 0">
                <span x-show="enemy.intent.includes('attack')">‚öîÔ∏è</span>
                <span x-show="enemy.intent === 'defend'">üõ°Ô∏è</span>
                <span class="font-bold text-red-400" x-text="enemy.intentVal > 0 ? enemy.intentVal : ''"></span>
            </div>

            <!-- Enemy Counter -->
            <div
                class="absolute top-4 right-4 bg-slate-900 px-3 py-1 rounded-full border border-slate-600 text-xs text-slate-400 font-bold shadow-lg">
                <span x-text="currentEnemyIndex + 1"></span>/<span x-text="maxEnemies"></span>
            </div>

            <!-- Enemy Avatar -->
            <div class="text-8xl mb-4 filter drop-shadow-lg transform transition-transform duration-500"
                :class="{'scale-110': gameState === 'enemy_turn'}">
                <span x-text="enemy.icon"></span>
            </div>

            <!-- Enemy HP Bar -->
            <div class="w-2/3 space-y-1">
                <div class="flex justify-between text-xs text-slate-400 font-bold">
                    <span x-text="enemy.name[lang]"></span>
                    <span><span x-text="enemy.hp"></span> / <span x-text="enemy.maxHp"></span></span>
                </div>
                <div class="h-3 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                    <div class="h-full bg-red-600 transition-all duration-300"
                        :style="`width: ${(enemy.hp / enemy.maxHp) * 100}%`"></div>
                </div>
            </div>
        </div>

        <!-- === PLAYER AREA (MIDDLE) === -->
        <div class="flex-none h-32 bg-slate-900 flex items-center justify-between px-8 border-b border-slate-800">
            <!-- Player Stats -->
            <div class="flex flex-col items-center gap-1">
                <div class="text-4xl">üßô‚Äç‚ôÇÔ∏è</div>
                <div class="text-xs font-bold text-slate-400">You</div>
            </div>

            <!-- HP & Block & Energy -->
            <div class="flex-1 ml-6 space-y-2">
                <!-- Block & Energy Row -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-cyan-400 font-bold" x-show="player.block > 0">
                        <span class="text-xl">üõ°Ô∏è</span>
                        <span x-text="player.block"></span>
                    </div>
                    <!-- Energy Display -->
                    <div class="flex items-center gap-1 text-yellow-400 font-bold ml-auto">
                        <span class="text-xl">‚ö°</span>
                        <span x-text="`${player.energy}/${player.maxEnergy}`"></span>
                    </div>
                </div>

                <!-- HP Bar -->
                <div class="w-full space-y-1">
                    <div class="flex justify-between text-xs text-slate-400 font-bold">
                        <span x-text="ui.hp"></span>
                        <span><span x-text="player.hp"></span> / <span x-text="player.maxHp"></span></span>
                    </div>
                    <div class="h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-700 relative">
                        <div class="h-full bg-green-600 transition-all duration-300"
                            :style="`width: ${(player.hp / player.maxHp) * 100}%`"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === COMBAT LOG (OVERLAY) === -->
        <div
            class="absolute top-1/2 left-0 right-0 pointer-events-none flex flex-col items-center justify-center space-y-1 z-10 opacity-80">
            <template x-for="(log, index) in combatLog" :key="index">
                <div class="text-sm font-bold text-white bg-black/50 px-2 py-0.5 rounded backdrop-blur-sm" x-text="log"
                    x-show="index < 3" x-transition></div>
            </template>
        </div>

        <!-- === CONTROLS (BOTTOM) === -->
        <div class="flex-1 bg-slate-900 p-4 flex flex-col gap-2">

            <!-- Hexagram Construction (Compact) -->
            <div
                class="h-24 bg-slate-950 rounded-lg border border-slate-800 p-2 flex flex-col-reverse justify-start gap-1 relative overflow-hidden shrink-0">
                <!-- Preview Stats -->
                <template x-if="previewStats">
                    <div class="absolute top-2 right-2 text-xs text-slate-500 font-mono text-right">
                        <div x-show="previewStats.atk > 0" class="text-red-400">ATK: <span
                                x-text="previewStats.atk"></span></div>
                        <div x-show="previewStats.def > 0" class="text-cyan-400">DEF: <span
                                x-text="previewStats.def"></span></div>
                        <div x-show="previewStats.heal > 0" class="text-green-400">HEAL: <span
                                x-text="previewStats.heal"></span></div>
                        <div x-show="previewStats.isResonance" class="text-amber-400 font-bold animate-pulse">RESONANCE!
                        </div>
                    </div>
                </template>

                <template x-for="(line, index) in lines" :key="index">
                    <div class="w-full transition-all duration-100">
                        <template x-if="line === 1">
                            <div class="h-2 w-full bg-amber-500 rounded shadow-sm"></div>
                        </template>
                        <template x-if="line === 0">
                            <div class="flex gap-2 h-2 w-full">
                                <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                                <div class="h-full w-1/2 bg-cyan-600 rounded shadow-sm"></div>
                            </div>
                        </template>
                    </div>
                </template>

                <div x-show="lines.length === 0" class="text-center text-slate-700 text-xs italic mt-auto mb-auto">
                    Construct Spell...
                </div>
            </div>

            <!-- Hand Area -->
            <div class="flex-1 flex items-center justify-center gap-4 relative px-16" x-data="{ hoveredCard: null }">

                <!-- Shared Tooltip (Prevents Clipping) -->
                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-slate-900/95 border border-slate-600 text-xs p-2 rounded w-40 z-30 shadow-xl pointer-events-none transition-opacity duration-200"
                    x-show="hoveredCard" x-transition:enter="opacity-0 translate-y-2"
                    x-transition:enter-end="opacity-100 translate-y-0" x-cloak>
                    <div class="text-center font-bold text-amber-500 mb-1" x-text="hoveredCard?.name[lang]"></div>
                    <div class="grid grid-cols-3 gap-1 text-[10px] font-mono">
                        <div class="flex flex-col items-center text-red-400" x-show="hoveredCard?.stats.atk > 0">
                            <span>ATK</span><span x-text="hoveredCard?.stats.atk" class="text-sm font-bold"></span>
                        </div>
                        <div class="flex flex-col items-center text-cyan-400" x-show="hoveredCard?.stats.def > 0">
                            <span>DEF</span><span x-text="hoveredCard?.stats.def" class="text-sm font-bold"></span>
                        </div>
                        <div class="flex flex-col items-center text-green-400" x-show="hoveredCard?.stats.heal > 0">
                            <span>HEAL</span><span x-text="hoveredCard?.stats.heal" class="text-sm font-bold"></span>
                        </div>
                    </div>
                </div>

                <!-- Deck Pile -->
                <div
                    class="absolute left-2 bottom-4 text-xs text-slate-500 flex flex-col items-center group cursor-help">
                    <div class="w-10 h-14 rounded mb-1 flex items-center justify-center text-lg transition-all duration-300"
                        :class="deck.length > 0 ? 'bg-slate-800 border border-slate-600 shadow-[2px_2px_0_#334155,3px_3px_0_#1e293b]' : 'border-2 border-dashed border-slate-800 bg-transparent opacity-50'">
                        <span x-show="deck.length > 0"
                            class="opacity-30 group-hover:opacity-60 transition-opacity">‚òØÔ∏è</span>
                    </div>
                    <span class="font-mono font-bold text-[10px]" x-text="`${ui.deck}: ${deck.length}`"></span>
                </div>

                <!-- Cards (Scrollable & Draggable) -->
                <div class="flex gap-2 items-end h-full pb-2 overflow-x-auto w-full justify-start px-4 no-scrollbar cursor-grab active:cursor-grabbing"
                    x-data="{ isDown: false, startX: 0, scrollLeft: 0, isDragging: false }"
                    @mousedown="isDown = true; isDragging = false; startX = $event.pageX - $el.offsetLeft; scrollLeft = $el.scrollLeft"
                    @mouseleave="isDown = false" @mouseup="isDown = false; setTimeout(() => isDragging = false, 50)"
                    @mousemove="if(!isDown) return; $event.preventDefault(); const x = $event.pageX - $el.offsetLeft; const walk = (x - startX) * 2; $el.scrollLeft = scrollLeft - walk; isDragging = true">

                    <template x-for="(card, index) in hand" :key="card.id">
                        <button @click="if(!isDragging) playCard(index)" @mouseenter="hoveredCard = card"
                            @mouseleave="hoveredCard = null"
                            class="w-20 h-28 rounded-lg shadow-lg border-2 flex flex-col items-center justify-center p-1 transition-transform hover:-translate-y-2 active:scale-95 relative group bg-slate-800 border-slate-600 text-slate-200 hover:border-amber-500 hover:text-amber-100 shrink-0 select-none">

                            <!-- Cost -->
                            <div
                                class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center text-xs font-bold text-yellow-400 shadow z-10">
                                <span x-text="card.cost"></span>
                            </div>

                            <!-- ËÆäÁàªÊ®ôË®ò -->
                            <div x-show="card.isChanging"
                                class="absolute -top-2 -right-2 bg-amber-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-lg z-10">
                                ‚ö°√ó<span x-text="card.changingLines ? card.changingLines.length : 0"></span>
                            </div>

                            <!-- Icon -->
                            <div class="text-4xl mb-1" x-text="card.icon"></div>

                            <!-- Name -->
                            <div class="text-xs font-bold text-center leading-tight" x-text="card.name[lang]"></div>
                        </button>
                    </template>

                    <!-- Spacer for right padding if needed -->
                    <div class="w-2 shrink-0"></div>
                </div>

                <!-- Discard Pile -->
                <div
                    class="absolute right-2 bottom-4 text-xs text-slate-500 flex flex-col items-center group cursor-help">
                    <div class="w-10 h-14 rounded mb-1 flex items-center justify-center text-lg transition-all duration-300"
                        :class="discard.length > 0 ? 'bg-slate-800 border border-slate-600 shadow-[2px_2px_0_#334155,3px_3px_0_#1e293b]' : 'border-2 border-dashed border-slate-800 bg-transparent opacity-50'">
                        <span x-show="discard.length > 0"
                            class="opacity-30 group-hover:opacity-60 transition-opacity">‚ôªÔ∏è</span>
                    </div>
                    <span class="font-mono font-bold text-[10px]" x-text="`${ui.discard}: ${discard.length}`"></span>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="h-12 flex gap-2">
                <!-- CAST BUTTON -->
                <button @click="castHexagram()" :disabled="lines.length !== 6"
                    class="flex-1 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-800 disabled:text-slate-600 text-white font-bold rounded shadow-lg transition-all flex items-center justify-center">
                    <span x-text="ui.cast"></span>
                </button>

                <!-- UNDO BUTTON -->
                <button @click="undoLastCard()" :disabled="lines.length < 3"
                    class="w-20 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-600 text-slate-200 font-bold rounded shadow-lg transition-all flex items-center justify-center border border-slate-600 text-xs">
                    <span x-text="lang === 'zh' ? 'Êí§Âõû' : 'Undo'"></span>
                </button>

                <!-- END TURN -->
                <button @click="endTurn()"
                    class="w-24 bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold rounded shadow-lg transition-all flex items-center justify-center border border-slate-600 text-xs">
                    <span x-text="ui.endTurn"></span>
                </button>
            </div>
        </div>

    </div>

</body>

</html>